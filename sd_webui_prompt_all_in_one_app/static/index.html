<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>sd-webui-prompt-all-in-one</title>
    <link rel="stylesheet" href="./css/main.min.css">
    <style>
        .topBar{
            display: flex;
            flex-direction: column;
        }
        .topBar .topBox{
            padding: 10px 0 0 10px;
            display: flex;
            align-items: center;
        }
        .closeIcon{
            width: 20px;
            height: 20px;
            fill: red;
        }
        .refreshIcon{
            width: 20px;
            height: 20px;
            fill: green;
        }
        .closeBtn{
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .refreshBtn{
            margin-left: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

    </style>
</head>
<body class="">
    <div class="topBar">
        <div class="topBox">
            <div class="closeBtn" onclick="closeDialog()">
                <div class="closeIcon">
                    <div class="icon-svg icon-svg-close" data-name="name" style=""><!--?xml version="1.0" encoding="UTF-8"?-->
                        <svg id="uuid-02c25950-3da6-4790-a038-e69a788fa473" data-name="图层 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14">
                        <path d="m14,1.41l-1.41-1.41-5.59,5.59L1.41,0,0,1.41l5.59,5.59L0,12.59l1.41,1.41,5.59-5.59,5.59,5.59,1.41-1.41-5.59-5.59L14,1.41Z"></path>
                        </svg>
                    </div>
                </div>
                <div style="padding-left: 10px;">关闭PromptUI</div>
            </div>
            <div class="refreshBtn" onclick="iNeedRefresh()">
                <div class="refreshIcon">
                    <div class="icon-svg icon-svg-refresh" data-name="name" style=""><!--?xml version="1.0" encoding="UTF-8"?-->
                        <svg id="uuid-471e7dd3-8710-47a7-a01a-33b30b047321" data-name="图层 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1022.73 870.84">
                          <path d="m698.85,706.29c-56.83,40.33-123.34,60.55-191.36,59.62-8.99-.09-17.93-.58-26.77-1.35-3.6-.34-7.19-.95-10.84-1.4-6.94-.95-13.88-1.9-20.62-3.22-4.2-.8-8.29-1.88-12.39-2.84-6.64-1.58-13.23-3.17-19.73-5.12-3.1-.97-6.14-2.09-9.24-3.15-7.44-2.52-14.88-5.14-22.12-8.21-1.65-.67-3.24-1.45-4.85-2.2-8.49-3.77-16.83-7.71-24.92-12.16-.4-.2-.7-.37-1.1-.57-27.37-15.21-52.39-34.21-74.36-56.41-.35-.35-.7-.75-1.05-1.15-6.84-6.91-13.33-14.18-19.52-21.72-1.3-1.62-2.55-3.34-3.85-4.98-44.7-56.61-71.66-128.24-71.66-206.16h75.81c1.95,0,3.85-1.05,4.85-2.89,1-1.83.85-4-.25-5.62l-127.39-193.48c-1-1.5-2.69-2.5-4.61-2.5s-3.59,1-4.59,2.5L.91,426.73c-1.08,1.65-1.25,3.8-.25,5.64,1,1.85,2.9,2.89,4.84,2.89h75.81c0,91.6,28.21,176.53,76.12,246.73.6.97,1,2.02,1.65,2.99,4.99,7.2,10.49,13.8,15.83,20.6,1.95,2.57,3.85,5.21,5.89,7.74,7.84,9.64,16.18,18.67,24.72,27.54.85.87,1.6,1.74,2.4,2.52,28.77,29.16,61.28,53.73,96.68,73.35.9.59,1.8,1.13,2.8,1.66,10.19,5.54,20.67,10.56,31.31,15.3,2.64,1.15,5.19,2.42,7.89,3.57,9.09,3.8,18.43,7.15,27.82,10.34,4.44,1.53,8.84,3.08,13.33,4.47,8.24,2.47,16.63,4.52,25.07,6.57,5.64,1.33,11.19,2.74,16.93,3.84,2.34.49,4.59,1.22,6.94,1.59,7.99,1.43,15.98,2.22,23.97,3.22,2.89.33,5.74.82,8.59,1.15,14.39,1.42,28.67,2.38,42.95,2.38,87.45,0,172.74-27.08,245.9-78.98,23.32-16.58,29.01-49.1,12.67-72.76-16.37-23.67-48.59-29.39-71.91-12.81m242.6-271.02c-.04-91.33-28.07-176.08-75.76-246.14-.71-1.2-1.2-2.42-1.95-3.52-5.95-8.57-12.39-16.55-18.83-24.57-.75-.98-1.45-2-2.24-2.95-43.65-53.6-98.43-95.03-160.55-122.1-1.7-.75-3.4-1.6-5.1-2.35-9.93-4.12-20.07-7.76-30.26-11.24-3.7-1.22-7.34-2.57-11.09-3.69-8.89-2.72-17.92-4.94-27.02-7.07-5.04-1.18-10.04-2.47-15.12-3.47-2.55-.5-4.9-1.25-7.4-1.69-6.79-1.2-13.64-1.73-20.42-2.6-4.7-.6-9.34-1.35-14.09-1.85-11.43-1.07-22.77-1.52-34.1-1.72-2.04,0-4.09-.32-6.14-.32-.35,0-.7.1-1.1.12-87.29.07-172.44,26.76-245.5,78.6-23.37,16.53-29.06,49.11-12.73,72.75,16.33,23.65,48.59,29.39,71.91,12.81,56.43-40.02,122.3-60.27,189.81-59.67,9.74.07,19.28.55,28.72,1.45,2.95.35,5.79.77,8.69,1.15,7.79.95,15.48,2.07,23.07,3.6,3.35.65,6.69,1.52,9.93,2.27,7.45,1.7,14.9,3.52,22.18,5.74,2.29.75,4.54,1.57,6.83,2.35,8.34,2.75,16.48,5.72,24.52,9.09.81.35,1.66.77,2.45,1.1,48.09,20.95,90.29,53.21,123.21,93.53.19.25.4.58.59.8,46.34,57.1,74.26,130.11,74.26,209.58h-75.81c-1.94,0-3.84,1.05-4.84,2.89-1,1.85-.85,4,.26,5.64l127.43,193.45c.96,1.49,2.66,2.47,4.6,2.47s3.59-.97,4.59-2.47l127.35-193.45c1.09-1.65,1.24-3.8.25-5.64-1.01-1.85-2.9-2.89-4.85-2.89h-75.75s0,0,0,0Z"></path>
                        </svg>
                    </div>
                </div>
                <div style="padding-left: 10px;">刷新PromptUI</div>
            </div>
            <!-- <button onclick="closeDialog()" >关闭PromptUI</button> -->
        </div>
        <div style="margin-top: 10px;padding-left: 10px;">在此输入提示词即可，当打开本UI的时候Comyfui正向提示词输入框默认只读无法编辑文本！</div>
        <div style="margin-top: 10px;padding-left: 10px;" id="yourIsEditing"></div>
    </div>
    <div id="tabs">
        <div id="tab_txt2img" class="tabitem gradio-tabitem svelte-19hvt5v">
            <div class="svelte-vt1mxs gap">
                <div id="txt2img_toprow" class="gradio-row svelte-15lo0d8 compact">
                    <div id="txt2img_prompt_container" class="gradio-column svelte-vt1mxs gap">
                        <div id="component-5173" class="gradio-row svelte-15lo0d8">
                            <div id="component-5174" class="gradio-column svelte-vt1mxs gap">
                                <div id="component-5175" class="gradio-row svelte-15lo0d8">
                                    <div class="form svelte-awbtu4">
                                        <div id="txt2img_token_counter" class="block gradio-html token-counter svelte-mppz8v padded" title="">
                                            <div class="wrap center svelte-gjihhp hide"></div>
                                            <div class="svelte-1ed2p3z">
                                                <div class="prose gradio-html token-counter svelte-1ybaih5" id="txt2img_token_counter">
                                                    <span class="gr-box gr-text-input">0/0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="txt2img_prompt" class="block gradio-textbox svelte-mppz8v padded">
                                            <label class="svelte-4xt1ch">
                                                <span class="svelte-1gfkn6j sr-only hide"></span>
                                                <textarea id="weilin_prompt_text_input" data-testid="textbox" class="scroll-hide svelte-4xt1ch autocomplete" placeholder="" rows="3"></textarea>
                                            </label>
                                            <my-component></my-component>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="component-5178" class="gradio-row svelte-15lo0d8" >
                            <div id="component-5179" class="gradio-column svelte-vt1mxs gap">
                                <div id="component-5180" class="gradio-row svelte-15lo0d8">
                                    <div class="form svelte-awbtu4">
                                        <div id="txt2img_negative_token_counter" class="block gradio-html token-counter svelte-mppz8v padded" title="">
                                            <div class="wrap center svelte-gjihhp hide"></div>
                                            <div class="svelte-1ed2p3z">
                                                <div class="prose gradio-html token-counter svelte-1ybaih5" id="txt2img_negative_token_counter">
                                                    <span class="gr-box gr-text-input">0/0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="txt2img_neg_prompt" class="block gradio-textbox svelte-mppz8v padded">
                                            <label class="svelte-4xt1ch">
                                                <span class="svelte-1gfkn6j sr-only hide"></span>
                                                <textarea id="weilin_prompt_text_neg_input" data-testid="textbox" class="scroll-hide svelte-4xt1ch autocomplete" placeholder="" rows="3"></textarea>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="txt2img_steps" class="block gradio-slider svelte-mppz8v padded">
                <div class="wrap default svelte-gjihhp hide"></div>
                <div class="wrap svelte-jigama">
                    <div class="head svelte-jigama">
                        <label for="range_id_1">
                            <span class="svelte-1gfkn6j">Steps</span>
                        </label>
                        <input type="number" min="1" max="150" step="1" class="svelte-jigama" value="20">
                    </div>
                </div>
                <input type="range" id="range_id_1" name="cowbell" min="1" max="150" step="1" class="svelte-jigama">
            </div>
        </div>
        <div id="tab_img2img" class="tabitem gradio-tabitem svelte-19hvt5v">
            <div class="svelte-vt1mxs gap">
                <div id="img2img_toprow" class="gradio-row svelte-15lo0d8 compact">
                    <div id="img2img_prompt_container" class="gradio-column svelte-vt1mxs gap">
                        <div id="component-5703" class="gradio-row svelte-15lo0d8">
                            <div id="component-5704" class="gradio-column svelte-vt1mxs gap">
                                <div id="component-5705" class="gradio-row svelte-15lo0d8">
                                    <div class="form svelte-awbtu4">
                                        <div id="img2img_token_counter" class="block gradio-html token-counter svelte-mppz8v padded" title="">
                                            <div class="wrap center svelte-gjihhp hide"></div>
                                            <div class="svelte-1ed2p3z">
                                                <div class="prose gradio-html token-counter svelte-1ybaih5" id="img2img_token_counter">
                                                    <span class="gr-box gr-text-input">0/0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="img2img_prompt" class="block gradio-textbox svelte-mppz8v padded">
                                            <label class="svelte-4xt1ch">
                                                <span class="svelte-1gfkn6j sr-only hide"></span>
                                                <textarea data-testid="textbox" class="scroll-hide svelte-4xt1ch autocomplete" placeholder="" rows="3"></textarea>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="component-5708" class="gradio-row svelte-15lo0d8">
                            <div id="component-5709" class="gradio-column svelte-vt1mxs gap">
                                <div id="component-5710" class="gradio-row svelte-15lo0d8">
                                    <div class="form svelte-awbtu4">
                                        <div id="img2img_negative_token_counter" class="block gradio-html token-counter svelte-mppz8v padded" title="">
                                            <div class="wrap center svelte-gjihhp hide"></div>
                                            <div class="svelte-1ed2p3z">
                                                <div class="prose gradio-html token-counter svelte-1ybaih5" id="img2img_negative_token_counter">
                                                    <span class="gr-box gr-text-input">0/0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="img2img_neg_prompt" class="block gradio-textbox svelte-mppz8v padded">
                                            <label class="svelte-4xt1ch">
                                                <span class="svelte-1gfkn6j sr-only hide"></span>
                                                <textarea data-testid="textbox" class="scroll-hide svelte-4xt1ch autocomplete" placeholder="" rows="3"></textarea>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="img2img_steps" class="block gradio-slider svelte-mppz8v padded">
                <div class="wrap default svelte-gjihhp hide"></div>
                <div class="wrap svelte-jigama">
                    <div class="head svelte-jigama">
                        <label for="range_id_20">
                            <span class="svelte-1gfkn6j">Steps</span>
                        </label>
                        <input type="number" min="1" max="150" step="1" class="svelte-jigama" value="20">
                    </div>
                </div>
                <input type="range" id="range_id_20" name="cowbell" min="1" max="150" step="1" class="svelte-jigama">
            </div>
        </div>
    </div>
    <div id="txt2img_checkpoints_cards">
        <div class="card"></div>
    </div>
</body>
<script>
    const APP_MODE = true
    let UiLoaded = []
    let embeddings = []
    let loras = []
    let opts = {}
    let thisRandomId = ''

    const params = new URL(window.location.href)
    const searchParams = params.searchParams
    const window_type =  searchParams.get('type')
    const ref_id =  searchParams.get('refid')
    const theme =  searchParams.get('__theme')
    thisRandomId = localStorage.getItem("weilin_prompt_randomid");
    const getTheme = localStorage.getItem("weilin_prompt_theme");

    // console.log(window_type)
    if(window_type == 'greate_prompt'){
        const ng_box = document.getElementById('component-5178')
        ng_box.style = "display: none !important";
        window.name = 'greate_prompt_xx_2024'
        const editingBox = document.getElementById('yourIsEditing')
        editingBox.innerText="你正在编辑 -> 正向提示词"
        
        const great_refid = localStorage.getItem("weilin_prompt_great_refid")
        if(ref_id != great_refid){
            window.top.postMessage({handel: 'getWeilinGreatPromptBox', randomid: thisRandomId}, "/");
        }
    }else if(window_type == 'neg_prompt'){
        const ng_box = document.getElementById('component-5173')
        ng_box.style = "display: none !important";
        window.name = 'neg_prompt_xx_2024'
        const editingBox = document.getElementById('yourIsEditing')
        editingBox.innerText="你正在编辑 -> 反向提示词"

        const neg_refid = localStorage.getItem("weilin_prompt_neg_refid")
        if(ref_id != neg_refid){
            window.top.postMessage({handel: 'getWeilinNegPromptBox', randomid: thisRandomId}, "/");
        }
    }
    
    if(theme != getTheme && (theme=='light' || theme=='dark' || theme == null)){
        localStorage.setItem("weilin_prompt_theme",theme);
        // 重新获取prompt
        if(window_type == 'greate_prompt'){
            window.top.postMessage({handel: 'getWeilinGreatPromptBox', randomid: thisRandomId}, "/");
        }else if(window_type == 'neg_prompt'){
            window.top.postMessage({handel: 'getWeilinNegPromptBox', randomid: thisRandomId}, "/");
        }
    }

    

    function selectCheckpoint(name) {
        var time = Math.floor(Math.random() * 2000 + 3000)
        setTimeout(function() {
            opts.sd_model_checkpoint = name
        }, time)
    }

    function onUiLoaded(callback) {
        UiLoaded.push(callback)
    }

    window.onload = function() {
        UiLoaded.forEach(function(callback) {
            callback()
        })
    }

    const log = document.getElementById("weilin_prompt_text_input");
    log.addEventListener("input", updateValue);
    const log2 = document.getElementById("weilin_prompt_text_neg_input");
    log2.addEventListener("input", updateValue);


    window.addEventListener('message', e => {
        // console.log(e.data)
      if(e.data.handel == 'openWeiLinGreatPromptSD'){
        if(window_type =='greate_prompt'){
            thisRandomId = e.data.randomid
            log.value = e.data.value
            // openDialog()
        }
      }else if(e.data.handel == 'openWeiLinNegPromptSD'){
        if(window_type =='neg_prompt'){
            thisRandomId = e.data.randomid
            log2.value = e.data.value
            // openDialog()
        }
      }else if(e.data.handel == 'responeseWeiLinGreatPromptGet'){
        if(window_type =='greate_prompt'){
            thisRandomId = e.data.randomid
            log.value = e.data.value
            // openDialog()
        }
      }else if(e.data.handel == 'responeseWeiLinNegPromptGet'){
        if(window_type =='neg_prompt'){
            thisRandomId = e.data.randomid
            log2.value = e.data.value
            // openDialog()
        }
      }
    }, false);

    function updateValue(e) {
        console.log(log.value)
        if(window_type =='greate_prompt'){
            window.top.postMessage({handel: 'changeWeiLinGreatePrompt',value: log.value,randomid: thisRandomId}, "/");
        }else if(window_type =='neg_prompt'){
            window.top.postMessage({handel: 'changeWeiLinNegPrompt',value: log2.value,randomid: thisRandomId}, "/");
        }
    }

    function openDialog(){
        const dialog = document.getElementById("weilin_promptGreateDialog");
        dialog.show()
    }

    function closeDialog(){
        // const dialog = document.getElementById("weilin_promptGreateDialog");
        // dialog.close()
        // console.log(thisRandomId)
        if(window_type =='greate_prompt'){
            window.top.postMessage({handel: 'closeWeilinGreatPromptBox', randomid: thisRandomId}, "/");
        }else if(window_type =='neg_prompt'){
            window.top.postMessage({handel: 'closeWeilinNegPromptBox', randomid: thisRandomId}, "/");
        }
    }

    // 刷新页面
    function iNeedRefresh(){
        window.top.postMessage({handel: 'refreshWeilinPromptBox', randomid: thisRandomId}, "/");
    }

    document.onkeydown=function(e){
        var keyNum=window.event ? e.keyCode :e.which;
        if(keyNum==27){  
            closeDialog()
        }  
    }

</script>
<script src="./js/jquery-3.7.1.min.js"></script>
<script src="./js/main.js"></script>
<script src="/sd-webui-prompt-all-in-one-js"></script>
</html>